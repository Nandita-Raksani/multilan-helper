<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 11px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
    }

    /* Language Bar */
    .lang-bar {
      display: flex;
      gap: 4px;
      padding: 8px;
      background: var(--figma-color-bg-secondary);
      border-bottom: 1px solid var(--figma-color-border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .lang-btn {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .lang-btn:hover {
      background: var(--figma-color-bg-hover);
    }

    .lang-btn.active {
      background: var(--figma-color-bg-brand);
      color: white;
      border-color: var(--figma-color-bg-brand);
    }

    .lang-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: var(--figma-color-text-secondary);
    }

    .tab:hover {
      background: var(--figma-color-bg-hover);
    }

    .tab.active {
      color: var(--figma-color-text);
      border-bottom-color: var(--figma-color-bg-brand);
    }

    /* Panel Content */
    .panel {
      display: none;
      padding: 12px;
      overflow-y: auto;
      max-height: calc(100vh - 140px);
    }

    .panel.active {
      display: block;
    }

    /* Search */
    .search-box {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      margin-bottom: 12px;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--figma-color-border-brand);
    }

    /* Text Node List */
    .text-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .text-item {
      padding: 10px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .text-item:hover {
      background: var(--figma-color-bg-hover);
    }

    .text-item.unlinked {
      border-left: 3px solid #f59e0b;
    }

    .text-item.linked {
      border-left: 3px solid #10b981;
    }

    .text-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .text-item-name {
      font-weight: 500;
      color: var(--figma-color-text);
    }

    .text-item-id {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      background: var(--figma-color-bg-secondary);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .text-item-unlinked {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: #f59e0b;
    }

    .btn-link-node {
      font-size: 9px;
      padding: 2px 8px;
      background: var(--figma-color-bg-brand);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-link-node:hover {
      opacity: 0.9;
    }

    .text-item-content {
      color: var(--figma-color-text-secondary);
      font-size: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Selected Node Panel */
    .selected-node {
      background: var(--figma-color-bg-secondary);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .selected-node h3 {
      font-size: 12px;
      margin-bottom: 8px;
    }

    .selected-node-text {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      word-break: break-word;
    }

    .translations-preview {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 8px;
    }

    .translation-row {
      display: flex;
      gap: 8px;
      font-size: 10px;
    }

    .translation-lang {
      width: 24px;
      font-weight: 600;
      color: var(--figma-color-text-secondary);
    }

    .translation-text {
      flex: 1;
      color: var(--figma-color-text);
    }

    /* Search Results */
    .search-results {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .search-result {
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      cursor: pointer;
    }

    .search-result:hover {
      background: var(--figma-color-bg-hover);
    }

    .search-result-id {
      font-weight: 500;
      margin-bottom: 4px;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s;
    }

    .btn-primary {
      background: var(--figma-color-bg-brand);
      color: white;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .btn-secondary {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    /* Status Bar */
    .status-bar {
      padding: 8px 12px;
      background: var(--figma-color-bg-secondary);
      border-top: 1px solid var(--figma-color-border);
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
    }

    /* View Mode Banner */
    .view-mode-banner {
      background: #fef3c7;
      color: #92400e;
      padding: 8px 12px;
      text-align: center;
      font-size: 11px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 24px;
      color: var(--figma-color-text-secondary);
    }

    /* Scope Toggle */
    .scope-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .scope-btn {
      flex: 1;
      padding: 6px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text-secondary);
      cursor: pointer;
      font-size: 10px;
    }

    .scope-btn.active {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border-color: var(--figma-color-border-brand);
    }

    /* Placeholder badge */
    .placeholder-badge {
      font-size: 9px;
      background: #f59e0b;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 4px;
    }

    .text-item.placeholder {
      border-left: 3px solid #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }

    /* Create Panel */
    .create-section {
      margin-bottom: 16px;
    }

    .create-section h4 {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--figma-color-text);
    }

    .lookup-result {
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
    }

    .lookup-result.not-found {
      border: 1px dashed #f59e0b;
    }

    .copy-btn {
      padding: 4px 8px;
      font-size: 10px;
      background: var(--figma-color-bg);
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      cursor: pointer;
      margin-left: 8px;
    }

    .copy-btn:hover {
      background: var(--figma-color-bg-hover);
    }

    .copy-btn.copied {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    /* Bulk Auto-Link Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--figma-color-bg);
      border-radius: 8px;
      padding: 16px;
      max-width: 300px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal h3 {
      margin-bottom: 12px;
      font-size: 14px;
    }

    .modal-section {
      margin-bottom: 16px;
    }

    .modal-section h4 {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--figma-color-text-secondary);
    }

    .match-item {
      padding: 8px;
      background: var(--figma-color-bg-secondary);
      border-radius: 4px;
      margin-bottom: 6px;
      font-size: 10px;
    }

    .match-item-text {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .match-item-id {
      color: var(--figma-color-text-secondary);
    }

    .fuzzy-suggestion {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px;
      background: var(--figma-color-bg);
      border-radius: 4px;
      margin-top: 4px;
    }

    .fuzzy-actions {
      display: flex;
      gap: 4px;
    }

    .fuzzy-actions button {
      padding: 4px 8px;
      font-size: 9px;
      border-radius: 3px;
      cursor: pointer;
      border: none;
    }

    .btn-accept {
      background: #10b981;
      color: white;
    }

    .btn-skip {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
    }

    .summary-stats {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 11px;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .stat-dot.exact { background: #10b981; }
    .stat-dot.fuzzy { background: #3b82f6; }
    .stat-dot.unmatched { background: #ef4444; }

    /* Auto-link button row */
    .texts-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .texts-header .scope-toggle {
      flex: 1;
      margin-bottom: 0;
    }

    .btn-auto-link {
      padding: 6px 10px;
      font-size: 10px;
      white-space: nowrap;
    }

    /* Search Panel */
    .search-panel-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      margin-bottom: 12px;
      font-size: 12px;
    }

    .search-panel-input:focus {
      outline: none;
      border-color: var(--figma-color-border-brand);
    }

    .search-hint {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 12px;
    }

    .search-result-card {
      padding: 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }

    .search-result-card:hover {
      background: var(--figma-color-bg-hover);
      border-color: var(--figma-color-border-brand);
    }

    .search-result-card:hover .multilanId-tooltip {
      opacity: 1;
      visibility: visible;
    }

    .multilanId-tooltip {
      position: absolute;
      top: -8px;
      right: 8px;
      background: var(--figma-color-bg-brand);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      opacity: 0;
      visibility: hidden;
      transition: all 0.15s;
      z-index: 5;
    }

    .search-result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .search-result-id {
      font-size: 11px;
      font-weight: 600;
      background: var(--figma-color-bg-brand);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .search-result-primary {
      font-size: 13px;
      font-weight: 500;
      color: var(--figma-color-text);
      flex: 1;
    }

    .btn-copy-id {
      font-size: 10px;
      padding: 4px 10px;
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-copy-id:hover {
      background: var(--figma-color-bg-tertiary);
    }

    .search-result-translations {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .search-result-lang {
      font-size: 10px;
      background: var(--figma-color-bg-secondary);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .search-result-lang strong {
      color: var(--figma-color-text-secondary);
      margin-right: 4px;
    }

    .search-result-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--figma-color-border);
    }

    .btn-create-text {
      padding: 6px 12px;
      font-size: 10px;
      background: var(--figma-color-bg-brand);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-create-text:hover {
      opacity: 0.9;
    }

    .btn-copy-text {
      padding: 6px 12px;
      font-size: 10px;
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      cursor: pointer;
    }

    .search-results-count {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- View Mode Banner (shown for non-editors) -->
    <div id="viewModeBanner" class="view-mode-banner" style="display: none;">
      View Mode - You can preview translations but cannot edit
    </div>

    <!-- Language Bar -->
    <div class="lang-bar">
      <button class="lang-btn" data-lang="en">EN</button>
      <button class="lang-btn" data-lang="fr">FR</button>
      <button class="lang-btn" data-lang="nl">NL</button>
      <button class="lang-btn" data-lang="de">DE</button>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="search">Search</div>
      <div class="tab" data-tab="texts">Texts</div>
      <div class="tab" data-tab="create">Create</div>
      <div class="tab" data-tab="settings">Settings</div>
    </div>

    <!-- Search Panel -->
    <div id="searchPanel" class="panel active">
      <input type="text" class="search-panel-input" id="globalSearchInput" placeholder="Search by multilanId or text...">
      <div class="search-hint">Browse available translations by ID or text content.</div>
      <div id="globalSearchResultsCount" class="search-results-count"></div>
      <div id="globalSearchResults"></div>
    </div>

    <!-- Texts Panel -->
    <div id="textsPanel" class="panel">
      <div class="texts-header">
        <div class="scope-toggle">
          <button class="scope-btn active" data-scope="page">Entire Page</button>
          <button class="scope-btn" data-scope="selection">Selection</button>
        </div>
        <button class="btn btn-secondary btn-auto-link" id="autoLinkBtn">Auto-Link All</button>
      </div>
      <input type="text" class="search-box" id="textSearch" placeholder="Filter texts...">
      <div id="textList" class="text-list">
        <div class="empty-state">Loading...</div>
      </div>
    </div>

    <!-- Create Panel -->
    <div id="createPanel" class="panel">
      <!-- Selected node info -->
      <div id="createSelectedNode" class="selected-node" style="display: none; margin-bottom: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h4 style="margin: 0;">Selected Node</h4>
          <span id="createSelectedBadge" class="text-item-id"></span>
        </div>
        <div id="createSelectedText" class="selected-node-text" style="margin-top: 4px;"></div>
      </div>

      <div class="create-section">
        <h4>Look up MultilanId</h4>
        <input type="text" class="search-box" id="multilanIdInput" placeholder="Enter multilanId (e.g., 12345)">
        <div id="lookupResult"></div>
      </div>

      <div class="create-section" id="placeholderSection" style="display: none;">
        <h4>Create Placeholder</h4>
        <p style="font-size: 10px; color: var(--figma-color-text-secondary); margin-bottom: 8px;">
          ID not found. Enter text manually and mark as placeholder.
        </p>
        <input type="text" class="search-box" id="placeholderText" placeholder="Enter placeholder text...">
        <div class="btn-row">
          <button class="btn btn-primary" id="markPlaceholderBtn" style="background: #f59e0b;">Mark as Placeholder</button>
        </div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="panel">
      <h3 style="margin-bottom: 12px;">Placeholder Values</h3>
      <div id="placeholderSettings">
        <div style="margin-bottom: 8px;">
          <label style="display: block; margin-bottom: 4px;">username</label>
          <input type="text" class="search-box" data-placeholder="username" value="John" style="margin-bottom: 0;">
        </div>
        <div style="margin-bottom: 8px;">
          <label style="display: block; margin-bottom: 4px;">count</label>
          <input type="text" class="search-box" data-placeholder="count" value="5" style="margin-bottom: 0;">
        </div>
      </div>
    </div>

    <!-- Bulk Auto-Link Modal -->
    <div id="bulkLinkModal" class="modal-overlay">
      <div class="modal">
        <h3>Auto-Link Results</h3>
        <div id="bulkLinkSummary" class="summary-stats"></div>
        <div id="bulkLinkContent"></div>
        <div class="btn-row">
          <button class="btn btn-secondary" id="closeBulkModal">Close</button>
          <button class="btn btn-primary" id="applyExactMatches" style="display: none;">Apply Exact Matches</button>
        </div>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <span id="statusText">Ready</span>
      <span id="buildTimestamp" style="float: right; opacity: 0.7;"></span>
    </div>
  </div>

  <script>
    // State
    let state = {
      canEdit: true,
      currentLang: 'en',
      scope: 'page',
      textNodes: [],
      selectedNode: null,
      placeholders: {
        username: 'John',
        count: '5'
      },
      lookupMultilanId: null,
      lookupResult: null,
      bulkLinkResults: null,
      globalSearchResults: [],
      allTranslations: []
    };

    // DOM Elements
    const langBtns = document.querySelectorAll('.lang-btn');
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.panel');
    const scopeBtns = document.querySelectorAll('.scope-btn');
    const textSearch = document.getElementById('textSearch');
    const textList = document.getElementById('textList');
    // Old Link panel elements removed - functionality merged into Search panel
    const statusText = document.getElementById('statusText');
    const viewModeBanner = document.getElementById('viewModeBanner');

    // Create panel elements
    const createSelectedNode = document.getElementById('createSelectedNode');
    const createSelectedBadge = document.getElementById('createSelectedBadge');
    const createSelectedText = document.getElementById('createSelectedText');
    const multilanIdInput = document.getElementById('multilanIdInput');
    const lookupResult = document.getElementById('lookupResult');
    const placeholderSection = document.getElementById('placeholderSection');
    const placeholderText = document.getElementById('placeholderText');
    const markPlaceholderBtn = document.getElementById('markPlaceholderBtn');

    // Bulk link elements
    const autoLinkBtn = document.getElementById('autoLinkBtn');
    const bulkLinkModal = document.getElementById('bulkLinkModal');
    const bulkLinkSummary = document.getElementById('bulkLinkSummary');
    const bulkLinkContent = document.getElementById('bulkLinkContent');
    const closeBulkModal = document.getElementById('closeBulkModal');
    const applyExactMatches = document.getElementById('applyExactMatches');

    // Global search elements
    const globalSearchInput = document.getElementById('globalSearchInput');
    const globalSearchResults = document.getElementById('globalSearchResults');
    const globalSearchResultsCount = document.getElementById('globalSearchResultsCount');

    // Initialize
    parent.postMessage({ pluginMessage: { type: 'init' } }, '*');

    // Language buttons
    langBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        if (!state.canEdit) {
          // In view mode, just highlight the button to show preview
          langBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.currentLang = btn.dataset.lang;
          renderTextList();
          return;
        }

        const lang = btn.dataset.lang;
        state.currentLang = lang;
        langBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        parent.postMessage({
          pluginMessage: {
            type: 'switch-language',
            language: lang,
            scope: state.scope,
            placeholders: state.placeholders
          }
        }, '*');
      });
    });

    // Tabs
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        panels.forEach(p => p.classList.remove('active'));
        document.getElementById(tab.dataset.tab + 'Panel').classList.add('active');
      });
    });

    // Scope toggle
    scopeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        scopeBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.scope = btn.dataset.scope;

        parent.postMessage({
          pluginMessage: { type: 'refresh', scope: state.scope }
        }, '*');
      });
    });

    // Text search filter
    textSearch.addEventListener('input', () => {
      renderTextList();
    });

    // Placeholder settings
    document.querySelectorAll('[data-placeholder]').forEach(input => {
      input.addEventListener('input', () => {
        state.placeholders[input.dataset.placeholder] = input.value;
      });
    });

    // Global search (Search panel)
    let globalSearchTimeout;
    globalSearchInput.addEventListener('input', () => {
      clearTimeout(globalSearchTimeout);
      globalSearchTimeout = setTimeout(() => {
        const query = globalSearchInput.value.trim();
        if (query.length >= 1) {
          parent.postMessage({
            pluginMessage: { type: 'global-search', searchQuery: query }
          }, '*');
        } else {
          state.globalSearchResults = [];
          renderGlobalSearchResults();
        }
      }, 200);
    });

    // Render global search results
    function renderGlobalSearchResults() {
      const results = state.globalSearchResults;

      if (results.length === 0) {
        globalSearchResultsCount.textContent = '';
        if (globalSearchInput.value.trim()) {
          globalSearchResults.innerHTML = '<div class="empty-state">No translations found</div>';
        } else {
          globalSearchResults.innerHTML = '<div class="empty-state">Start typing to search translations</div>';
        }
        return;
      }

      globalSearchResultsCount.textContent = `${results.length} result${results.length > 1 ? 's' : ''} found`;

      globalSearchResults.innerHTML = results.map(result => {
        return `
          <div class="search-result-card" data-multilan-id="${escapeHtml(result.multilanId)}">
            <div class="search-result-header">
              <span class="search-result-primary">${escapeHtml(result.multilanId)}</span>
              <button class="btn-copy-id" data-id="${escapeHtml(result.multilanId)}">Copy ID</button>
            </div>
            <div class="translations-preview">
              ${Object.entries(result.translations).map(([lang, text]) => `
                <div class="translation-row">
                  <span class="translation-lang">${lang.toUpperCase()}</span>
                  <span class="translation-text">${escapeHtml(text)}</span>
                  <button class="copy-btn" data-text="${escapeHtml(text)}">Copy</button>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');

      // Add copy ID handlers
      globalSearchResults.querySelectorAll('.btn-copy-id').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          if (copyToClipboard(id)) {
            btn.textContent = 'Copied!';
            setTimeout(() => {
              btn.textContent = 'Copy ID';
            }, 1500);
          }
        });
      });

      // Add copy text handlers
      globalSearchResults.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const text = btn.dataset.text;
          if (copyToClipboard(text)) {
            btn.textContent = 'Copied!';
            setTimeout(() => {
              btn.textContent = 'Copy';
            }, 1500);
          }
        });
      });
    }

    // MultilanId lookup (Create panel)
    let lookupTimeout;
    multilanIdInput.addEventListener('input', () => {
      clearTimeout(lookupTimeout);
      lookupTimeout = setTimeout(() => {
        const id = multilanIdInput.value.trim();
        if (id.length >= 1) {
          state.lookupMultilanId = id;
          parent.postMessage({
            pluginMessage: { type: 'lookup-multilanId', multilanId: id }
          }, '*');
        } else {
          lookupResult.innerHTML = '';
          placeholderSection.style.display = 'none';
          state.lookupMultilanId = null;
          state.lookupResult = null;
        }
      }, 300);
    });

    // Mark as placeholder button
    markPlaceholderBtn.addEventListener('click', () => {
      const text = placeholderText.value.trim();
      if (!text) {
        alert('Please enter placeholder text');
        return;
      }
      if (!state.lookupMultilanId) {
        alert('Please enter a multilanId first');
        return;
      }
      if (!state.selectedNode) {
        alert('Please select a text layer in Figma first');
        return;
      }

      parent.postMessage({
        pluginMessage: {
          type: 'mark-as-placeholder',
          multilanId: state.lookupMultilanId,
          text: text
        }
      }, '*');

      // Clear inputs
      placeholderText.value = '';
    });

    // Auto-Link All button
    autoLinkBtn.addEventListener('click', () => {
      if (!state.canEdit) {
        alert('You do not have edit permissions');
        return;
      }
      statusText.textContent = 'Scanning for matches...';
      autoLinkBtn.disabled = true;
      parent.postMessage({
        pluginMessage: { type: 'bulk-auto-link', scope: state.scope }
      }, '*');
      // Re-enable button after a short delay
      setTimeout(() => { autoLinkBtn.disabled = false; }, 1000);
    });

    // Close bulk link modal
    closeBulkModal.addEventListener('click', () => {
      bulkLinkModal.classList.remove('active');
      // Refresh the list
      parent.postMessage({
        pluginMessage: { type: 'refresh', scope: state.scope }
      }, '*');
    });

    // Apply exact matches button
    applyExactMatches.addEventListener('click', () => {
      if (!state.bulkLinkResults || !state.bulkLinkResults.exactMatches) return;

      const confirmations = state.bulkLinkResults.exactMatches.map(m => ({
        nodeId: m.nodeId,
        multilanId: m.multilanId
      }));

      parent.postMessage({
        pluginMessage: {
          type: 'apply-exact-matches',
          confirmations,
          scope: state.scope
        }
      }, '*');

      // Hide the apply button and update UI
      applyExactMatches.style.display = 'none';
      state.bulkLinkResults.exactMatches = [];
      renderBulkLinkResults();
    });

    // Update selected node display in Create panel
    function updateCreateSelectedNode() {
      if (state.selectedNode) {
        createSelectedNode.style.display = 'block';
        createSelectedText.textContent = `"${state.selectedNode.characters}"`;
        if (state.selectedNode.multilanId) {
          createSelectedBadge.textContent = state.selectedNode.multilanId;
          createSelectedBadge.style.background = '#10b981';
        } else {
          createSelectedBadge.textContent = 'Not linked';
          createSelectedBadge.style.background = '#f59e0b';
        }
      } else {
        createSelectedNode.style.display = 'none';
      }
      // Re-render lookup result to update Link button visibility
      if (state.lookupResult) {
        renderLookupResult();
      }
    }

    // Render lookup result
    function renderLookupResult() {
      if (!state.lookupResult) {
        lookupResult.innerHTML = '';
        placeholderSection.style.display = 'none';
        return;
      }

      const hasUnlinkedSelection = state.selectedNode && !state.selectedNode.multilanId;

      if (state.lookupResult.found) {
        placeholderSection.style.display = 'none';
        const translations = state.lookupResult.translations;
        const multilanId = state.lookupResult.multilanId;
        const primaryText = translations[state.currentLang] || translations['en'] || Object.values(translations)[0];

        lookupResult.innerHTML = `
          <div class="lookup-result">
            <div style="font-weight: 500; margin-bottom: 8px;">ID: ${escapeHtml(multilanId)}</div>
            <div class="translations-preview">
              ${Object.entries(translations).map(([lang, text]) => `
                <div class="translation-row" style="align-items: center;">
                  <span class="translation-lang">${lang.toUpperCase()}</span>
                  <span class="translation-text" style="flex: 1;">${escapeHtml(text)}</span>
                  <button class="copy-btn" data-text="${escapeHtml(text)}">Copy</button>
                </div>
              `).join('')}
            </div>
            <div class="btn-row" style="margin-top: 12px;">
              <button class="btn btn-primary" id="createTextNodeBtn">Create Text Node</button>
              ${hasUnlinkedSelection ? `<button class="btn btn-secondary" id="linkToSelectedBtn" style="background: #10b981; color: white;">Link to Selected</button>` : ''}
            </div>
          </div>
        `;

        // Add copy handlers
        lookupResult.querySelectorAll('.copy-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const text = btn.dataset.text;
            if (copyToClipboard(text)) {
              btn.textContent = 'Copied!';
              btn.classList.add('copied');
              setTimeout(() => {
                btn.textContent = 'Copy';
                btn.classList.remove('copied');
              }, 1500);
            } else {
              alert('Failed to copy to clipboard');
            }
          });
        });

        // Add create text node handler
        const createBtn = document.getElementById('createTextNodeBtn');
        if (createBtn) {
          createBtn.addEventListener('click', () => {
            parent.postMessage({
              pluginMessage: {
                type: 'create-linked-text',
                multilanId: multilanId,
                text: primaryText,
                language: state.currentLang
              }
            }, '*');
          });
        }

        // Add link to selected handler
        const linkBtn = document.getElementById('linkToSelectedBtn');
        if (linkBtn) {
          linkBtn.addEventListener('click', () => {
            if (!state.selectedNode) return;
            parent.postMessage({
              pluginMessage: {
                type: 'link-node',
                nodeId: state.selectedNode.id,
                multilanId: multilanId
              }
            }, '*');
          });
        }
      } else {
        placeholderSection.style.display = 'block';
        lookupResult.innerHTML = `
          <div class="lookup-result not-found">
            <div style="color: #f59e0b; font-weight: 500;">ID not found: ${escapeHtml(state.lookupResult.multilanId)}</div>
            <div style="font-size: 10px; margin-top: 4px; color: var(--figma-color-text-secondary);">
              You can create a placeholder text below.
            </div>
          </div>
        `;
      }
    }

    // Render bulk link results
    function renderBulkLinkResults() {
      if (!state.bulkLinkResults) return;

      const { exactMatches, fuzzyMatches, unmatched } = state.bulkLinkResults;

      // Summary
      bulkLinkSummary.innerHTML = `
        <div class="stat"><span class="stat-dot exact"></span> ${exactMatches.length} exact</div>
        <div class="stat"><span class="stat-dot fuzzy"></span> ${fuzzyMatches.length} fuzzy</div>
        <div class="stat"><span class="stat-dot unmatched"></span> ${unmatched.length} unmatched</div>
      `;

      // Show/hide apply button
      applyExactMatches.style.display = exactMatches.length > 0 ? 'block' : 'none';

      let content = '';

      // Exact matches
      if (exactMatches.length > 0) {
        content += `
          <div class="modal-section">
            <h4>Exact Matches (will be auto-linked)</h4>
            ${exactMatches.map(m => `
              <div class="match-item">
                <div class="match-item-text">${escapeHtml(m.text.slice(0, 50))}${m.text.length > 50 ? '...' : ''}</div>
                <div class="match-item-id">â†’ ${escapeHtml(m.multilanId)}</div>
              </div>
            `).join('')}
          </div>
        `;
      }

      // Fuzzy matches
      if (fuzzyMatches.length > 0) {
        content += `
          <div class="modal-section">
            <h4>Possible Matches (review needed)</h4>
            ${fuzzyMatches.map(m => `
              <div class="match-item">
                <div class="match-item-text">${escapeHtml(m.text.slice(0, 50))}${m.text.length > 50 ? '...' : ''}</div>
                ${m.suggestions.slice(0, 2).map(s => `
                  <div class="fuzzy-suggestion">
                    <span>${escapeHtml(s.multilanId)}</span>
                    <div class="fuzzy-actions">
                      <button class="btn-accept" data-node="${m.nodeId}" data-id="${s.multilanId}">Link</button>
                      <button class="btn-skip">Skip</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `).join('')}
          </div>
        `;
      }

      // Unmatched
      if (unmatched.length > 0) {
        content += `
          <div class="modal-section">
            <h4>No Matches Found</h4>
            ${unmatched.slice(0, 5).map(m => `
              <div class="match-item">
                <div class="match-item-text">${escapeHtml(m.text.slice(0, 50))}${m.text.length > 50 ? '...' : ''}</div>
              </div>
            `).join('')}
            ${unmatched.length > 5 ? `<div style="font-size: 10px; color: var(--figma-color-text-secondary);">...and ${unmatched.length - 5} more</div>` : ''}
          </div>
        `;
      }

      if (!content) {
        content = '<div class="empty-state">No unlinked text nodes found</div>';
      }

      bulkLinkContent.innerHTML = content;

      // Add handlers for fuzzy match buttons
      bulkLinkContent.querySelectorAll('.btn-accept').forEach(btn => {
        btn.addEventListener('click', () => {
          const nodeId = btn.dataset.node;
          const multilanId = btn.dataset.id;
          parent.postMessage({
            pluginMessage: {
              type: 'confirm-fuzzy-link',
              nodeId,
              multilanId
            }
          }, '*');
          // Remove this item from the UI
          btn.closest('.match-item').remove();
        });
      });

      bulkLinkContent.querySelectorAll('.btn-skip').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.closest('.fuzzy-suggestion').remove();
        });
      });
    }

    // Render text nodes list
    function renderTextList() {
      const filter = textSearch.value.toLowerCase();
      const filtered = state.textNodes.filter(node => {
        return node.name.toLowerCase().includes(filter) ||
               node.characters.toLowerCase().includes(filter) ||
               (node.multilanId && node.multilanId.toLowerCase().includes(filter));
      });

      if (filtered.length === 0) {
        textList.innerHTML = '<div class="empty-state">No text layers found</div>';
        return;
      }

      textList.innerHTML = filtered.map(node => {
        let itemClass = node.multilanId ? 'linked' : 'unlinked';
        if (node.isPlaceholder) itemClass = 'placeholder';
        const translations = node.translations || {};
        const previewText = translations[state.currentLang] || node.characters;
        const placeholderBadge = node.isPlaceholder ? '<span class="placeholder-badge">Placeholder</span>' : '';
        const linkButton = !node.multilanId ? `<button class="btn-link-node" data-id="${node.id}" data-text="${escapeHtml(node.characters)}">Link</button>` : '';

        return `
          <div class="text-item ${itemClass}" data-id="${node.id}">
            <div class="text-item-header">
              <span class="text-item-name">${escapeHtml(node.name)}${placeholderBadge}</span>
              ${node.multilanId ? `<span class="text-item-id">${escapeHtml(node.multilanId)}</span>` : `<span class="text-item-unlinked">Not linked ${linkButton}</span>`}
            </div>
            <div class="text-item-content">${escapeHtml(previewText)}</div>
          </div>
        `;
      }).join('');

      // Add click handlers for selecting nodes
      textList.querySelectorAll('.text-item').forEach(item => {
        item.addEventListener('click', (e) => {
          // Don't select if clicking buttons
          if (e.target.classList.contains('btn-link-node')) return;
          parent.postMessage({
            pluginMessage: { type: 'select-node', nodeId: item.dataset.id }
          }, '*');
        });
      });

      // Add click handlers for link buttons
      textList.querySelectorAll('.btn-link-node').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const nodeId = btn.dataset.id;
          const text = btn.dataset.text;

          // Select the node first
          parent.postMessage({
            pluginMessage: { type: 'select-node', nodeId }
          }, '*');

          // Switch to Create tab and search for the text
          document.querySelector('[data-tab="create"]').click();

          // Pre-fill the multilanId input with the text to search
          multilanIdInput.value = text.slice(0, 30);
          multilanIdInput.dispatchEvent(new Event('input'));
        });
      });
    }

    // Unlink node
    function unlinkNode(nodeId) {
      parent.postMessage({
        pluginMessage: { type: 'unlink-node', nodeId }
      }, '*');
    }

    // Copy to clipboard (works in Figma iframe)
    function copyToClipboard(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        return true;
      } catch (err) {
        return false;
      } finally {
        document.body.removeChild(textarea);
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Handle messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      switch (msg.type) {
        case 'init':
          state.canEdit = msg.canEdit;
          state.textNodes = msg.textNodes || [];
          state.selectedNode = msg.selectedNode;

          if (!state.canEdit) {
            viewModeBanner.style.display = 'block';
            langBtns.forEach(btn => btn.disabled = false); // Allow preview switching
          }

          statusText.textContent = `${msg.translationCount} translations loaded`;
          if (msg.buildTimestamp) {
            document.getElementById('buildTimestamp').textContent = `Updated: ${msg.buildTimestamp}`;
          }
          renderTextList();
          updateCreateSelectedNode();
          break;

        case 'text-nodes-updated':
          state.textNodes = msg.textNodes || [];
          if (msg.selectedNode !== undefined) {
            state.selectedNode = msg.selectedNode;
            updateCreateSelectedNode();
          }
          renderTextList();
          break;

        case 'selection-changed':
          state.selectedNode = msg.selectedNode;
          updateCreateSelectedNode();
          break;

        case 'language-switched':
          statusText.textContent = `Updated ${msg.success} texts`;
          if (msg.missing.length > 0) {
            statusText.textContent += ` (${msg.missing.length} missing translations)`;
          }
          break;

        case 'lookup-result':
          state.lookupResult = {
            multilanId: msg.multilanId,
            translations: msg.translations,
            found: msg.found
          };
          renderLookupResult();
          break;

        case 'bulk-auto-link-results':
          state.bulkLinkResults = {
            exactMatches: msg.exactMatches || [],
            fuzzyMatches: msg.fuzzyMatches || [],
            unmatched: msg.unmatched || []
          };
          renderBulkLinkResults();
          bulkLinkModal.classList.add('active');
          break;

        case 'global-search-results':
          state.globalSearchResults = msg.results || [];
          renderGlobalSearchResults();
          break;

        case 'text-created':
          statusText.textContent = `Created text node linked to ${msg.multilanId}`;
          // Refresh text list
          parent.postMessage({
            pluginMessage: { type: 'refresh', scope: state.scope }
          }, '*');
          break;
      }
    };
  </script>
</body>
</html>
